#!/bin/bash
set -x

command -v apt \
  && sudo apt update \
  && sudo apt -y upgrade \
  && sudo apt full-upgrade \
  && sudo apt autoremove \
  && sudo apt autoclean

command -v asdf \
  && asdf update \
  && asdf plugin update --all \
  && asdf plugin list | xargs -I{} asdf install {} latest \
  && asdf plugin list | xargs -I{} asdf global {} latest

if command -v pyenv; then
  pyenv update
  pyenv latest install --skip-existing 2> /dev/null
  PYTHON_LATEST="$(pyenv latest prefix 2> /dev/null | tail -1)"
  PYTHON_PIPX="$(pyenv virtualenv-prefix pipx_default_python 2> /dev/null)"
  if [ -n "${PYTHON_LATEST}" ] && [ "${PYTHON_LATEST}" != "${PYTHON_PIPX}" ]; then
    PIPX_UPGRADED_PYTHON="$(pyenv latest -P)"
    pyenv virtualenv-delete -f pipx_default_python
    pyenv virtualenv "${PIPX_UPGRADED_PYTHON}" pipx_default_python
  fi
fi

command -v pipx \
  && ([ -n "${PIPX_UPGRADED_PYTHON}" ] && pipx reinstall-all || pipx upgrade-all --include-injected)

command -v vim \
  && vim +PlugUpgrade +PlugUpdate +qall

command -v flatpak \
  && flatpak update -y
